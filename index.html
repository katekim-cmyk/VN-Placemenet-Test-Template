<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>통합 성적 관리 시스템</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: auto; padding: 20px; border: 1px solid #ccc; }
        
        /* Admin Section Styles */
        .admin-section { border-bottom: 3px solid #333; margin-bottom: 30px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 10px; background-color: #f2f2f2; }
        .admin-content { display: none; padding-top: 20px; }
        .admin-content.active { display: block; }
        .control-panel { margin-bottom: 30px; }
        .control-panel .student-info { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .control-panel .student-info > div { flex: 1; min-width: 200px; }
        .setting-section table { width: 100%; border-collapse: collapse; }
        .setting-section th, .setting-section td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .setting-section th { background-color: #e9e9e9; }
        .setting-section input[type="text"], .setting-section input[type="number"], .setting-section select { width: 90%; padding: 5px; }
        .admin-button { padding: 10px 15px; background-color: #007BFF; color: white; border: none; cursor: pointer; }
        
        /* New styles for disabled inputs and subject tables */
        input[readonly], select[disabled] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        /* Student Section Styles */
        .student-section { padding-top: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header p { display: flex; justify-content: center; gap: 20px; }
        .header span { font-weight: bold; }
        .print-button-container { text-align: right; margin-bottom: 15px; }
        .print-button { padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; font-size: 16px; }
        .nav-menu { text-align: center; margin-bottom: 20px; }
        .nav-menu a { margin: 0 10px; text-decoration: none; color: #007BFF; font-weight: bold; }
        .page { display: none; }
        .page.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .correct { color: green; font-weight: bold; }
        .incorrect { color: red; font-weight: bold; }
        
        /* General Analysis table specific styles */
        #general-analysis th, #general-analysis td { text-align: center; }
        #general-analysis th.subject-cell { text-align: left; background-color: #f2f2f2; }
        #general-analysis td.subject-cell { text-align: left; background-color: #f2f2f2; }
        
        /* New class for standard score alignment */
        .standard-score-cell { text-align: center; }
        .level-header-cell { text-align: center; }

        /* Common table column widths and alignments */
        .col-no { width: 40px; text-align: center; }
        .col-skills, .col-category { text-align: left; }
        th.col-skills, th.col-category { text-align: center; }
        .col-content-level { width: 120px; text-align: center; }
        .col-result { width: 80px; text-align: center; }
        .col-correct { text-align: center; width: 120px; }
        .col-score { text-align: center; }

        #result-cell { text-align: center; margin-top: 20px; background-color: #ffe8e8; padding: 10px; color: red; }
        
        /* Print-specific CSS */
        @media print {
            body { 
                margin: 0;
                -webkit-print-color-adjust: exact; /* For WebKit browsers */
                print-color-adjust: exact; /* For other browsers */
            }
            .admin-section, .nav-menu, .print-button-container { display: none; }
            .container { border: none; padding: 0; margin: 0; }
            .no-break-print { page-break-inside: avoid; }
            .page { display: block; page-break-after: always; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="admin-section">
            <div class="admin-header" onclick="toggleStandardContent()">
                <h3>Standard Settings</h3>
                <span>▶</span>
            </div>
            <div id="standard-content" class="admin-content">
                <div class="control-panel">
                    <label for="select-grade-standard">Grade Level:</label>
                    <select id="select-grade-standard" onchange="updateLevelOptions();">
                        <option value="1">1학년</option>
                        <option value="2">2학년</option>
                        <option value="3">3학년</option>
                        <option value="4">4학년</option>
                    </select>
                    <label for="select-semester-standard">학기 선택:</label>
                    <select id="select-semester-standard" onchange="generateStandardFields()">
                        <option value="1stSem">1st Sem.</option>
                        <option value="2ndSem">2nd Sem.</option>
                    </select>
                    <label for="select-level-standard">Level:</label>
                    <select id="select-level-standard" onchange="generateStandardFields();">
                    </select>
                </div>
                <div id="standards-display"></div>
            </div>

            <div class="admin-header" onclick="toggleAdminContent()">
                <h3>Student Info & Test Results</h3>
                <span>▶</span>
            </div>
            <div id="admin-content" class="admin-content">
                <div class="control-panel">
                    <h4>Student Information</h4>
                    <div class="student-info">
                        <div>
                            <label for="student-name-input">Name:</label>
                            <input type="text" id="student-name-input" placeholder="Student Name">
                        </div>
                        <div>
                            <label for="test-date-input">Test Date:</label>
                            <input type="date" id="test-date-input">
                        </div>
                        <div>
                            <label for="select-grade">Grade Level:</label>
                            <select id="select-grade" onchange="loadGradeSettings()">
                                <option value="1">1학년</option>
                                <option value="2">2학년</option>
                                <option value="3">3학년</option>
                                <option value="4">4학년</option>
                            </select>
                        </div>
                        <div>
                            <label for="star-reading-input">Star Reading Score:</label>
                            <input type="number" id="star-reading-input" min="0" max="100" step="0.1">
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="select-subject">Subject:</label>
                        <select id="select-subject" onchange="generateQuestionFields()">
                            <option value="">Select a Subject</option>
                            <option value="speaking">Speaking</option>
                            <option value="english">English</option>
                            <option value="speech-building">Speech Building</option>
                            <option value="eng-foundations">Eng. Foundations</option>
                            <option value="listening">Listening</option>
                        </select>
                        <button class="admin-button" onclick="saveSettings()">Save Results</button>
                        <button class="admin-button" onclick="resetFields()">Reset</button>
                    </div>
                    <div id="settings-display">
                        </div>
                </div>
            </div>
        </div>

        <div class="student-section">
            <div class="header">
                <h2>REPORT CARD</h2>
                <p>
                    <span><strong>Name:</strong> <span id="student-name-display"></span></span>
                    <span><strong>Test Date:</strong> <span id="test-date-display"></span></span>
                    <span><strong>Grade Level:</strong> <span id="student-grade-display"></span></span>
                </p>
            </div>
            <div class="print-button-container">
                <button class="print-button" onclick="window.print()">⎙ Print</button>
            </div>
            <div class="nav-menu">
                <a href="#" onclick="showPage('overall')">Overall</a> |
                <a href="#" onclick="showPage('speaking')">Speaking</a> |
                <a href="#" onclick="showPage('english')">English</a> |
                <a href="#" onclick="showPage('speech')">Speech Building</a> |
                <a href="#" onclick="showPage('foundations')">Eng. Foundations</a> |
                <a href="#" onclick="showPage('listening')">Listening</a>
            </div>

            <div id="page-overall" class="page active">
                <h3>Overall Report</h3>
                <h4>General Analysis</h4>
                <div id="general-analysis-table-container"></div>
            </div>

            <div id="page-speaking" class="page">
                <h3>Speaking Tested Skill</h3>
                <div class="no-break-print">
                    <h4>Strength & Weakness Analysis</h4>
                    <div id="speaking-results-s"></div>
                </div>
            </div>
            
            <div id="page-english" class="page">
                <h3>English Tested Skill</h3>
                <div id="english-results-q"></div>
                <div class="no-break-print">
                    <h4>Strength & Weakness Analysis</h4>
                    <div id="english-results-s"></div>
                </div>
            </div>
            
            <div id="page-speech" class="page">
                <h3>Speech Building Tested Skill</h3>
                <div id="speech-results-q"></div>
                <div class="no-break-print">
                    <h4>Strength & Weakness Analysis</h4>
                    <div id="speech-results-s"></div>
                </div>
            </div>
            
            <div id="page-foundations" class="page">
                <h3>Eng. Foundations Tested Skill</h3>
                <div id="foundations-results-q"></div>
                <div class="no-break-print">
                    <h4>Strength & Weakness Analysis</h4>
                    <div id="foundations-results-s"></div>
                </div>
            </div>
            
            <div id="page-listening" class="page">
                <h3>Listening Tested Skill</h3>
                <div id="listening-results-q"></div>
                <div class="no-break-print">
                    <h4>Strength & Weakness Analysis</h4>
                    <div id="listening-results-s"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const subjectQuestionCounts = {
            'speaking': 16, 'english': 20, 'speech-building': 20, 'eng-foundations': 10, 'listening': 10
        };
        const levelMap = {
            '1': {
                '1stSem': ['1A', '1B', '2A'],
                '2ndSem': ['1A', '1B', '2A']
            },
            '2': {
                '1stSem': ['1A', '1B', '2A', '2B', '3A'],
                '2ndSem': ['1A', '1B', '2A', '2B', '3A']
            },
            '3': {
                '1stSem': ['2B', '3A', '4A'],
                '2ndSem': ['2A', '2B', '3A', '3B', '4A']
            },
            '4': {
                '1stSem': ['3C', '4A'],
                '2ndSem': ['3A', '3B', '4A', '4B']
            }
        };
        const analysisSubjects = ['english', 'speech-building', 'eng-foundations', 'listening'];
        const mainSubjects = ['speaking', 'english', 'speech-building', 'eng-foundations', 'listening'];
        const speakingCategories = {
            'Repeat / Read Aloud': { start: 1, end: 5, totalScore: 20 },
            'Sentence Completion': { start: 6, end: 10, totalScore: 20 },
            'Storytelling': { start: 11, end: 11, totalScore: 4 },
            'Social Interaction': { start: 12, end: 16, totalScore: 20 }
        };
        const speakingScores = { 4: 'Excellent', 3: 'Very Good', 2: 'Good', 1: 'Fair', 0: 'Poor' };

        function getPageId(subjectKey) {
            if (subjectKey === 'speech-building') return 'speech';
            if (subjectKey === 'eng-foundations') return 'foundations';
            return subjectKey;
        }

        function toggleStandardContent() {
            const content = document.getElementById('standard-content');
            const arrow = document.querySelector('.admin-section:first-of-type .admin-header span');
            content.classList.toggle('active');
            arrow.textContent = content.classList.contains('active') ? '▼' : '▶';
        }

        function toggleAdminContent() {
            const content = document.getElementById('admin-content');
            const arrow = document.querySelector('.admin-section:last-of-type .admin-header span');
            content.classList.toggle('active');
            arrow.textContent = content.classList.contains('active') ? '▼' : '▶';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
        }

        function loadStudentInfo() {
            const studentInfo = JSON.parse(localStorage.getItem('student-info')) || {};
            document.getElementById('student-name-input').value = studentInfo.name || '';
            document.getElementById('test-date-input').value = studentInfo.date || '';
            document.getElementById('select-grade').value = studentInfo.grade || '1';
            document.getElementById('select-grade-standard').value = studentInfo.grade || '1';
            document.getElementById('select-semester-standard').value = studentInfo.semester || '1stSem';
            document.getElementById('star-reading-input').value = studentInfo.starReading || '';

            document.getElementById('student-name-display').textContent = studentInfo.name || '';
            document.getElementById('test-date-display').textContent = studentInfo.date || '';
            document.getElementById('student-grade-display').textContent = (studentInfo.grade || '1') + '학년';
        }

        function loadGradeSettings() {
            const grade = document.getElementById('select-grade').value;
            const studentInfo = JSON.parse(localStorage.getItem('student-info')) || {};
            studentInfo.grade = grade;
            localStorage.setItem('student-info', JSON.stringify(studentInfo));

            updateLevelOptions();
            generateQuestionFields();
            loadStudentData();
        }

        function updateLevelOptions() {
            const grade = document.getElementById('select-grade-standard').value;
            const semester = document.getElementById('select-semester-standard').value;
            const levelSelect = document.getElementById('select-level-standard');
            const levels = levelMap[grade][semester] || [];
            
            const existingLevelsWithData = levels.filter(level => localStorage.getItem(`standard-settings-${grade}-${level}-${semester}`));
            
            levelSelect.innerHTML = '';
            existingLevelsWithData.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = level;
                levelSelect.appendChild(option);
            });
            generateStandardFields();
        }

        function generateStandardFields() {
            const grade = document.getElementById('select-grade-standard').value;
            const level = document.getElementById('select-level-standard').value;
            const semester = document.getElementById('select-semester-standard').value;
            const container = document.getElementById('standards-display');
            container.innerHTML = '';

            if (level) {
                const savedStandards = JSON.parse(localStorage.getItem(`standard-settings-${grade}-${level}-${semester}`)) || {};

                let html = `<h4>${grade}학년 - ${level} 기준 점수 (${semester === '1stSem' ? '1st Sem.' : '2nd Sem.'})</h4><table><thead><tr><th>과목</th><th>기준 점수</th></tr></thead><tbody>`;

                analysisSubjects.forEach(subject => {
                    const score = savedStandards[subject] || '';
                    const subjectDisplayName = subject.charAt(0).toUpperCase() + subject.slice(1).replace('eng-', 'Eng.').replace('speech-building', 'Speech Building');
                    html += `<tr><td>${subjectDisplayName}</td><td><input type="number" id="standard-${subject}" value="${score}" readonly></td></tr>`;
                });

                const starReadingScore = savedStandards['star-reading'] || '';
                html += `<tr><td>Star Reading</td><td><input type="number" id="standard-star-reading" value="${starReadingScore}" step="0.1" readonly></td></tr>`;

                html += `</tbody></table>`;
                container.innerHTML = html;
            }
        }

        function saveStandards() {
            const grade = document.getElementById('select-grade-standard').value;
            const level = document.getElementById('select-level-standard').value;
            const semester = document.getElementById('select-semester-standard').value;
            
            if (!level) {
                alert('레벨을 선택하세요.');
                return;
            }

            const standards = {};
            analysisSubjects.forEach(subject => {
                standards[subject] = document.getElementById(`standard-${subject}`).value;
            });
            standards['star-reading'] = document.getElementById('standard-star-reading').value;

            localStorage.setItem(`standard-settings-${grade}-${level}-${semester}`, JSON.stringify(standards));
            alert('기준이 저장되었습니다. Overall Report에 반영됩니다.');
            loadStudentData();
        }
        
        function resetFields() {
            const grade = document.getElementById('select-grade').value;
            const subjectKey = document.getElementById('select-subject').value;

            if (subjectKey) {
                // Clear localStorage data for the current subject
                localStorage.removeItem(`test-settings-${grade}-${subjectKey}`);

                // Clear UI
                if (subjectKey === 'speaking') {
                    for (let i = 1; i <= subjectQuestionCounts[subjectKey]; i++) {
                        const radios = document.querySelectorAll(`input[name="speaking-score-q${i}"]`);
                        radios.forEach(radio => radio.checked = false);
                    }
                } else {
                    for (let i = 1; i <= subjectQuestionCounts[subjectKey]; i++) {
                        const checkbox = document.getElementById(`correct-q${i}`);
                        if (checkbox) checkbox.checked = false;
                        const skillInput = document.getElementById(`skill-q${i}`);
                        if (skillInput) skillInput.value = '';
                        const levelSelect = document.getElementById(`level-q${i}`);
                        if (levelSelect) levelSelect.value = '1';
                    }
                }
            }
            loadStudentData();
        }

        function generateQuestionFields() {
            const grade = document.getElementById('select-grade').value;
            const subjectKey = document.getElementById('select-subject').value;
            const container = document.getElementById('settings-display');
            container.innerHTML = '';

            if (subjectKey === 'speaking') {
                const savedData = JSON.parse(localStorage.getItem(`test-settings-${grade}-${subjectKey}`)) || {};
                let tableHtml = `<h4>Speaking 설정</h4><table style="text-align: center;"><thead><tr><th>Category</th><th>No.</th><th>Excellent (4)</th><th>Very Good (3)</th><th>Good (2)</th><th>Fair (1)</th><th>Poor (0)</th></tr></thead><tbody>`;
                
                for (const category in speakingCategories) {
                    const { start, end } = speakingCategories[category];
                    const rowSpan = end - start + 1;
                    let isFirstRow = true;
                    for (let i = start; i <= end; i++) {
                        const qData = savedData.questions ? savedData.questions.find(q => q.number === i) : {};
                        const scoreValue = qData.score !== undefined ? qData.score : -1;
                        
                        tableHtml += `<tr>`;
                        if (isFirstRow) {
                            tableHtml += `<td rowspan="${rowSpan}">${category}</td>`;
                            isFirstRow = false;
                        }
                        tableHtml += `<td>${String(i).padStart(2, '0')}</td>`;
                        for (let score = 4; score >= 0; score--) {
                            tableHtml += `<td><input type="radio" name="speaking-score-q${i}" value="${score}" ${score == scoreValue ? 'checked' : ''}></td>`;
                        }
                        tableHtml += '</tr>';
                    }
                }
                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;
            } else if (subjectKey) {
                const numQuestions = subjectQuestionCounts[subjectKey];
                const savedData = JSON.parse(localStorage.getItem(`test-settings-${grade}-${subjectKey}`)) || {};
                
                const tableHeader = '<thead><tr><th class="col-no">No.</th><th class="col-skills">Skills</th><th class="col-content-level">Content Level</th><th class="col-result">Result</th></tr></thead>';
                
                let levelOptions = '';
                const maxLevel = grade === '4' ? 6 : 5;
                for (let i = 1; i <= maxLevel; i++) {
                    levelOptions += `<option value="${i}">${'★'.repeat(i)}</option>`;
                }

                let tableBody = '<tbody>';
                for (let i = 1; i <= numQuestions; i++) {
                    const qData = savedData.questions ? savedData.questions.find(q => q.number === i) : {};
                    const skillValue = qData.skill || '';
                    const levelValue = qData.contentLevel || '1';
                    const isCorrect = qData.isCorrect || false;
                        
                    tableBody += `
                        <tr>
                            <td class="col-no">${i}</td>
                            <td class="col-skills"><input type="text" placeholder="Skill" id="skill-q${i}" value="${skillValue}"></td>
                            <td class="col-content-level">
                                <select id="level-q${i}">
                                    ${levelOptions.replace(new RegExp(`value="${levelValue}"`), `value="${levelValue}" selected`)}
                                </select>
                            </td>
                            <td class="col-result"><input type="checkbox" id="correct-q${i}" ${isCorrect ? 'checked' : ''}></td>
                        </tr>
                    `;
                }
                tableBody += '</tbody>';
                
                const table = document.createElement('table');
                table.innerHTML = tableHeader + tableBody;
                
                const section = document.createElement('div');
                section.className = 'setting-section';
                section.innerHTML = `<h4>${subjectKey.charAt(0).toUpperCase() + subjectKey.slice(1).replace('-', ' ')} 설정</h4>`;
                section.appendChild(table);
                container.appendChild(section);
            }
        }

        function saveSettings() {
            const studentName = document.getElementById('student-name-input').value;
            const testDate = document.getElementById('test-date-input').value;
            const grade = document.getElementById('select-grade').value;
            const starReadingScore = document.getElementById('star-reading-input').value;
            const subjectKey = document.getElementById('select-subject').value;
            const semester = document.getElementById('select-semester-standard').value;

            const studentInfo = {
                name: studentName,
                date: testDate,
                grade: grade,
                starReading: starReadingScore
            };
            localStorage.setItem('student-info', JSON.stringify(studentInfo));

            if (!subjectKey) {
                alert('Select a subject.');
                loadStudentInfo();
                loadStudentData();
                return;
            }

            const numQuestions = subjectQuestionCounts[subjectKey];
            const settings = { questions: [] };
            let hasSubmitted = false;

            if (subjectKey === 'speaking') {
                for (let i = 1; i <= numQuestions; i++) {
                    const selectedScore = document.querySelector(`input[name="speaking-score-q${i}"]:checked`);
                    const score = selectedScore ? parseInt(selectedScore.value) : -1;
                    if (score > -1) hasSubmitted = true;
                    settings.questions.push({
                        number: i,
                        score: score
                    });
                }
            } else {
                for (let i = 1; i <= numQuestions; i++) {
                    const skill = document.getElementById(`skill-q${i}`).value;
                    const isCorrect = document.getElementById(`correct-q${i}`).checked;
                    let level = document.getElementById(`level-q${i}`).value;

                    if (isCorrect) hasSubmitted = true;

                    settings.questions.push({
                        number: i,
                        skill: skill,
                        contentLevel: parseInt(level),
                        isCorrect: isCorrect
                    });
                }
            }
            
            settings.isSaved = hasSubmitted;
            localStorage.setItem(`test-settings-${grade}-${subjectKey}`, JSON.stringify(settings));
            alert('Settings saved. The report card will be updated.');
            loadStudentInfo();
            loadStudentData();
        }

        function getFinalLevel(studentScores, allStandards) {
            let finalLevel = '-';
            const grade = document.getElementById('select-grade').value;
            const semester = document.getElementById('select-semester-standard').value;
            const levels = levelMap[grade][semester].slice().sort((a, b) => b.localeCompare(a));
            let hasAnyScore = false;
            
            for (const subject of analysisSubjects) {
                const data = JSON.parse(localStorage.getItem(`test-settings-${grade}-${subject}`)) || {};
                if (data.isSaved) hasAnyScore = true;
            }
            const studentInfo = JSON.parse(localStorage.getItem('student-info')) || {};
            if (studentInfo.starReading !== null && studentInfo.starReading !== '') hasAnyScore = true;

            if (!hasAnyScore) {
                return '-';
            }
            
            for (const level of levels) {
                let meetsAllCriteria = true;
                const levelStandards = allStandards[level] || {};

                analysisSubjects.forEach(subject => {
                    const studentScore = studentScores[subject].score;
                    const standardScore = levelStandards[subject];
                    if (studentScore < parseInt(standardScore)) {
                        meetsAllCriteria = false;
                    }
                });

                const starReadingScore = studentScores['star-reading'];
                const starReadingStandard = levelStandards['star-reading'];
                if (starReadingScore < parseFloat(starReadingStandard)) {
                    meetsAllCriteria = false;
                }

                if (meetsAllCriteria) {
                    finalLevel = level;
                    break;
                }
            }
            return finalLevel;
        }

        function loadStudentData() {
            const grade = document.getElementById('select-grade').value;
            const semester = document.getElementById('select-semester-standard').value;
            const studentInfo = JSON.parse(localStorage.getItem('student-info')) || {};
            const starReadingScore = studentInfo.starReading ? parseFloat(studentInfo.starReading) : null;
            const relevantLevels = levelMap[grade][semester] || [];
            
            let totalScores = {};
            let studentTotalScore = 0;
            let totalPossibleScore = 0;
            let hasAnyScore = false;

            // Clear previous data
            document.getElementById('general-analysis-table-container').innerHTML = '';
            mainSubjects.forEach(subjectKey => {
                const pageId = getPageId(subjectKey);
                document.getElementById(`${pageId}-results-s`).innerHTML = '';
                if(document.getElementById(`${pageId}-results-q`)) {
                    document.getElementById(`${pageId}-results-q`).innerHTML = '';
                }
            });

            mainSubjects.forEach(subjectKey => {
                const data = JSON.parse(localStorage.getItem(`test-settings-${grade}-${subjectKey}`)) || {};
                let correctCount = 0;
                let totalCount = subjectQuestionCounts[subjectKey];
                let scoreEntered = data.isSaved || false;

                if (subjectKey === 'speaking') {
                    let speakingScore = 0;
                    if (data.questions) {
                        data.questions.forEach(q => {
                            if (q.score > -1) {
                                speakingScore += q.score;
                            }
                        });
                    }
                    if (scoreEntered) hasAnyScore = true;
                    totalScores[subjectKey] = { score: speakingScore, percentage: scoreEntered ? Math.round((speakingScore / 64) * 100) : null, totalCount: 64, scoreEntered: scoreEntered };
                } else {
                    if (data.questions) {
                        data.questions.forEach(q => {
                            if (q.isCorrect) correctCount++;
                        });
                    }
                    const score = correctCount;
                    if (scoreEntered) hasAnyScore = true;
                    const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : null;
                    totalScores[subjectKey] = { score, percentage, totalCount, scoreEntered: scoreEntered };
                }

                if (analysisSubjects.includes(subjectKey)) {
                    if (totalScores[subjectKey].scoreEntered) {
                        studentTotalScore += totalScores[subjectKey].score;
                        totalPossibleScore += totalScores[subjectKey].totalCount;
                    }
                }
            });
            if (starReadingScore !== null) hasAnyScore = true;
            for (const subjectKey in totalScores) {
                if (totalScores[subjectKey].scoreEntered) {
                    hasAnyScore = true;
                    break;
                }
            }


            // Load standards from localStorage
            const allStandards = {};
            relevantLevels.forEach(level => {
                allStandards[level] = JSON.parse(localStorage.getItem(`standard-settings-${grade}-${level}-${semester}`)) || {};
            });
            

            // Generate General Analysis Table
            let tableHtml = `<table id="general-analysis"><thead>
                                <tr>
                                    <th rowspan="2" class="subject-cell">Subject</th>
                                    <th rowspan="2">Total Score</th>
                                    <th rowspan="2">Score</th>
                                    <th colspan="${relevantLevels.length}">Standard</th>
                                    <th rowspan="2">Percentage(%)</th>
                                </tr>
                                <tr>`;
            relevantLevels.forEach(level => {
                tableHtml += `<th class="level-header-cell">${level}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            analysisSubjects.forEach(subjectKey => {
                const subjectDisplayName = subjectKey.charAt(0).toUpperCase() + subjectKey.slice(1).replace('eng-', 'Eng.').replace('speech-building', 'Speech Building');
                const studentScore = totalScores[subjectKey].score;
                const studentPercentage = totalScores[subjectKey].percentage;
                const subjectTotal = totalScores[subjectKey].totalCount;
                const scoreDisplay = totalScores[subjectKey].scoreEntered ? studentScore : '-';
                const percentageDisplay = totalScores[subjectKey].scoreEntered ? studentPercentage + '%' : '-';

                tableHtml += `<tr>
                                <td class="subject-cell">${subjectDisplayName}</td>
                                <td>${subjectTotal}</td>
                                <td>${scoreDisplay}</td>`;

                relevantLevels.forEach(level => {
                    const standardScore = allStandards[level][subjectKey];
                    tableHtml += `<td class="standard-score-cell">${standardScore || '-'}</td>`;
                });

                tableHtml += `<td>${percentageDisplay}</td></tr>`;
            });

            // Total row
            const studentTotalPercentage = totalPossibleScore > 0 ? Math.round((studentTotalScore / totalPossibleScore) * 100) : 0;
            const totalScoreDisplay = hasAnyScore ? studentTotalScore : '-';
            const totalPercentageDisplay = hasAnyScore ? studentTotalPercentage + '%' : '-';
            
            tableHtml += `<tr>
                            <td class="subject-cell">Total</td>
                            <td>${totalPossibleScore}</td>
                            <td>${totalScoreDisplay}</td>`;

            relevantLevels.forEach(level => {
                let standardTotal = 0;
                analysisSubjects.forEach(subjectKey => {
                    const standardScore = allStandards[level][subjectKey] || 0;
                    standardTotal += parseInt(standardScore);
                });
                tableHtml += `<td class="standard-score-cell">${standardTotal}</td>`;
            });
            
            tableHtml += `<td>${totalPercentageDisplay}</td></tr>`;

            // Star Reading row
            const starReadingDisplay = starReadingScore !== null ? starReadingScore.toFixed(1) : '-';
            
            tableHtml += `<tr>
                            <td class="subject-cell">Star Reading</td>
                            <td>-</td>
                            <td>${starReadingDisplay}</td>`;

            relevantLevels.forEach(level => {
                const standardScore = allStandards[level]['star-reading'];
                tableHtml += `<td class="standard-score-cell">${standardScore || '-'}</td>`;
            });

            tableHtml += `<td>-</td></tr>`;
            tableHtml += `</tbody></table>`;

            // Final result
            const studentScoresForLevel = {};
            analysisSubjects.forEach(s => studentScoresForLevel[s] = totalScores[s]);
            studentScoresForLevel['star-reading'] = starReadingScore;

            const finalLevel = getFinalLevel(studentScoresForLevel, allStandards);
            const resultDisplay = hasAnyScore ? finalLevel : '-';
            tableHtml += `<div id="result-cell"><h3>Result : ${resultDisplay}</h3></div>`;

            document.getElementById('general-analysis-table-container').innerHTML = tableHtml;

            // Populate individual subject pages
            mainSubjects.forEach(subjectKey => {
                const data = JSON.parse(localStorage.getItem(`test-settings-${grade}-${subjectKey}`)) || {};
                const pageId = getPageId(subjectKey);
                
                if (subjectKey === 'speaking') {
                    const sTable = document.createElement('table');
                    sTable.classList.add('subject-s-table');
                    let sTableHeader = '<thead><tr><th class="col-no">No.</th><th class="col-category">Category</th><th class="col-correct">Correct</th></tr></thead>';
                    let sTableBody = '<tbody>';
                    let sNo = 1;
                    
                    for (const category in speakingCategories) {
                        const { start, end, totalScore } = speakingCategories[category];
                        let categoryScore = 0;
                        for(let i = start; i <= end; i++) {
                            const qData = data.questions ? data.questions.find(q => q.number === i) : {};
                            categoryScore += qData && q.score !== undefined ? qData.score : 0;
                        }
                        sTableBody += `<tr><td class="col-no">${sNo++}</td><td class="col-category">${category}</td><td class="col-correct">${categoryScore}/${totalScore}</td></tr>`;
                    }
                    sTable.innerHTML = sTableHeader + sTableBody + '</tbody>';
                    document.getElementById(`${pageId}-results-s`).innerHTML = sTable.outerHTML;

                } else { // All other subjects
                    const qTable = document.createElement('table');
                    qTable.classList.add('subject-q-table');
                    let qTableHeader = '<thead><tr><th class="col-no">No.</th><th class="col-skills">Skills</th><th class="col-content-level">Content Level</th><th class="col-result">Result</th></tr></thead>';
                    let qTableBody = '<tbody>';
                    let sTable = document.createElement('table');
                    sTable.classList.add('subject-s-table');
                    let sTableHeader = '<thead><tr><th class="col-no">No.</th><th class="col-skills">Skills</th><th class="col-correct">Correct</th><th class="col-score">Score</th></tr></thead>';
                    let sTableBody = '<tbody>';
                    let skillResults = {};

                    if (data.questions) {
                        data.questions.forEach(q => {
                            const isCorrect = q.isCorrect;
                            qTableBody += `<tr><td class="col-no">${q.number}</td><td class="col-skills">${q.skill || 'N/A'}</td><td class="col-content-level">${`★`.repeat(q.contentLevel)}</td><td class="col-result ${isCorrect ? 'correct' : 'incorrect'}">${isCorrect ? 'O' : 'X'}</td></tr>`;
                            if (q.skill) {
                                if (!skillResults[q.skill]) {
                                    skillResults[q.skill] = { correct: 0, total: 0 };
                                }
                                skillResults[q.skill].correct += isCorrect ? 1 : 0;
                                skillResults[q.skill].total++;
                            }
                        });
                    }
                    qTable.innerHTML = qTableHeader + qTableBody + '</tbody>';
                    document.getElementById(`${pageId}-results-q`).innerHTML = qTable.outerHTML;

                    let sNo = 1;
                    for (const skill in skillResults) {
                        const result = skillResults[skill];
                        const score = result.total > 0 ? Math.round((result.correct / result.total) * 100) : 0;
                        sTableBody += `<tr><td class="col-no">${sNo++}</td><td class="col-skills">${skill || 'N/A'}</td><td class="col-correct">${result.correct}/${result.total}</td><td class="col-score">${score}%</td></tr>`;
                    }
                    sTable.innerHTML = sTableHeader + sTableBody + '</tbody>';
                    document.getElementById(`${pageId}-results-s`).innerHTML = sTable.outerHTML;
                }
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadStudentInfo();
            updateLevelOptions();
            generateQuestionFields();
            loadStudentData();
            document.getElementById('select-grade').addEventListener('change', loadGradeSettings);
            document.getElementById('select-grade-standard').addEventListener('change', updateLevelOptions);
            document.getElementById('select-subject').addEventListener('change', () => {
                generateQuestionFields();
            });
        });
    </script>
</body>
</html>